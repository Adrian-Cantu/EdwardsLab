import os
from collections import OrderedDict
import subprocess
'This program takes a list of .faa files from all.fna and calculates every one vs every other one on a unix machine'
'This script was intended to be used on all.fna downloaded from NCBI database on a unix machine'

blastBaseDirectory = '/Users/jon6/ncbi-blast-2.2.29+/'
directoryFNAfiles = '/Users/jon6/ncbi-blast-2.2.29+/'
saveOutFileNamesDirectory = '/Users/jon6/ncbi-blast-2.2.29+/outFiles/'
ext = ".fna"
vs = '__vs__'

listOfFiles = []
for root, subdir, files in os.walk(directoryFNAfiles, topdown=True):
    for file in files:
        currentDirectory = subdir
        if file.endswith(ext):
            currentFile = ((os.path.join(root, file)))
            listOfFiles.append(currentFile)
listOfFilesNoRepeats = list(OrderedDict.fromkeys(listOfFiles))
print (listOfFilesNoRepeats)

n =  len(listOfFilesNoRepeats)
print (n)
os.chdir(blastBaseDirectory)
print (os.getcwd())

for i in range(0,n):
    for j in range(i,n):
        if(listOfFilesNoRepeats[i] is not listOfFilesNoRepeats[j]):
            outFileName = (os.path.basename(os.path.splitext(listOfFilesNoRepeats[i])[0])+vs+os.path.basename(os.path.splitext(listOfFilesNoRepeats[j])[0]))
            saveOutFileNamesPath = saveOutFileNamesDirectory + outFileName + ".out"
            blast_command = 'blastn -query '+ os.path.basename(listOfFilesNoRepeats[i]) +' -subject '+os.path.basename(listOfFilesNoRepeats[j]) + ' -out ' + saveOutFileNamesPath + ' ' + '-task blastn -dust no -outfmt "6 std qlen slen"'
            print (blast_command)
            process = subprocess.Popen(blast_command, stdout=subprocess.PIPE, stderr=None, shell=True)
            output = process.communicate()
            p_status = process.wait()
            print ("return code:", p_status)


